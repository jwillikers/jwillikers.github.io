<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>My SSH Configuration | JWillikers</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="My SSH Configuration" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Handy admin and dev guides from my myriad of tinkering" />
<meta property="og:description" content="Handy admin and dev guides from my myriad of tinkering" />
<link rel="canonical" href="https://jwillikers.com/my-ssh-configuration-index" />
<meta property="og:url" content="https://jwillikers.com/my-ssh-configuration-index" />
<meta property="og:site_name" content="JWillikers" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-29T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="My SSH Configuration" />
<script type="application/ld+json">
{"description":"Handy admin and dev guides from my myriad of tinkering","headline":"My SSH Configuration","dateModified":"2020-09-29T00:00:00+00:00","url":"https://jwillikers.com/my-ssh-configuration-index","datePublished":"2020-09-29T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jwillikers.com/my-ssh-configuration-index"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jwillikers.com/feed.xml" title="JWillikers" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/css/asciidoctor.css"></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">JWillikers</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">My SSH Configuration</h1>
    <p class="post-meta"><time class="dt-published" datetime="2020-09-29T00:00:00+00:00" itemprop="datePublished">
        Sep 29, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://www.openssh.com/">OpenSSH</a> client and server applications are ubiquitous.
Like many a software dev, I&#8217;m `ssh&#8217;ing all over the place.
And you know what?
I&#8217;ve put off learning the ins and outs of its configuration for far too long.
I learned that a little bit of know-how can simplify my day-to-day use of SSH.
That&#8217;s exactly why I&#8217;ve written this post to exemplify the configuration options I&#8217;m now using.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ssh_configuration">SSH Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The file <code>~/.ssh/config</code> contains a user&#8217;s SSH configuration.
Settings here can be defined per-host.
General configuration options include aliases, SSH agent behavior, and jump hosts to name a few.
Different sections of a sample <code>~/.ssh/config</code> are discussed in detail below.
Further documentation is available from the <a href="https://man.openbsd.org/ssh_config"><code>ssh_config</code> manpage</a>.
This article assumes the reader is familiar with the basics of SSH and the syntax of SSH configuration files.</p>
</div>
<div class="sect2">
<h3 id="localhost">Localhost</h3>
<div class="paragraph">
<p>The first option does not reside in a <a href="https://man.openbsd.org/ssh_config#Host"><code>Host</code></a> or <a href="https://man.openbsd.org/ssh_config#Match"><code>Match</code></a> block because it only refers to one host, <code>localhost</code> on the current machine.</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="rouge highlight"><code>NoHostAuthenticationForLocalhost yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally, SSH consults the <code>~/.ssh/known_hosts</code> when connecting to a host.
The known hosts file stores an identifying key for each host it has connected to previously.
As connections are made to new hosts, keys are registered in the user&#8217;s known hosts file.
Each time SSH establishes a connection to a known host, the key is checked, and the connection is aborted if it does not match.</p>
</div>
<div class="paragraph">
<p>When running multiple SSH servers from a single host, the key will fail to match whenever switching servers.
If you connect to various VMs through <code>localhost</code>, SSH will throw an error whenever switching between machines.
Setting <a href="https://man.openbsd.org/ssh_config#NoHostAuthenticationForLocalhost"><code>NoHostAuthenticationForLocalhost</code></a> to <code>yes</code> is a convenient way to workaround by skipping host checking is skipped for <code>localhost</code> altogether.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This does not skip host checking for the <code>localhost</code> address available on jump hosts.
See the section below on <code>HostKeyAlias</code> for such a use case.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="a_humble_host_alias">A Humble Host Alias</h3>
<div class="paragraph">
<p>The following section contains only one option which applies to <code>vm_host</code>.
As an example, <code>vm_host</code> represents a computer dedicated for running multiple virtual machines.</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="rouge highlight"><code>Host vm_host
  Hostname vm_host.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>The option, <a href="https://man.openbsd.org/ssh_config#Hostname"><code>Hostname</code></a>, indicates the true hostname of this host which means <code>vm_host</code> is really just an alias.
The alias <code>vm_host</code> can be used on the command-line instead of having to type out <code>vm_host.local</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jump_hosts_and_multiple_servers_on_a_single_host">Jump Hosts and Multiple Servers on a Single Host</h3>
<div class="paragraph">
<p>Next, several configuration options are given for the hosts <code>vm1</code> and <code>vm2</code>.</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="rouge highlight"><code>Host vm1
  HostKeyAlias vm1.localhost

Host vm2
  HostKeyAlias vm2.localhost

Host vm1 vm2
  Hostname localhost
  Port 9001
  ProxyJump vm_host</code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting with the shared configuration options, the <code>Hostname</code> and <a href="https://man.openbsd.org/ssh_config#Port"><code>Port</code></a> options indicate that both hosts are available on the port <code>9001</code> at the reserved <code>localhost</code> address.
Since both <code>vm1</code> and <code>vm2</code> use the same hostname and port, they can&#8217;t both be available simultaneously.
In this scenario, either virtual machine <code>vm1</code> or <code>vm2</code> would be available at any one time.</p>
</div>
<div class="paragraph">
<p>The <a href="https://man.openbsd.org/ssh_config#ProxyJump"><code>ProxyJump</code></a> key is used here with one intermediate host, <code>vm_host</code>, defined previously.
This means that the SSH connection will connect to the <code>localhost</code> address on <code>vm_host</code>.
So, instead of executing <code>ssh vm_host</code> followed by <code>ssh -p 9001 localhost</code> to access either of the VMs, use just one command either <code>ssh vm1</code> or <code>ssh vm2</code>.</p>
</div>
<div class="paragraph">
<p>The individual host blocks provide a distinct <a href="https://man.openbsd.org/ssh_config#HostKeyAlias"><code>HostKeyAlias</code></a> for each host.
This is critical because these virtual machines will have different host keys but share the same hostname <code>localhost</code>.
When checking the known hosts file, instead of looking for an entry for <code>localhost</code>, SSH will look for an entry for the value provided to <code>HostKeyAlias</code>.
The configuration line <code>NoHostAuthenticationForLocalhost yes</code> from the beginning of the file <em>only</em> works for the <code>localhost</code> address on the <em>current</em> machine.
In other words, this option has no effect when connecting to <code>localhost</code> on any other machine, including a jump host.
According to the <a href="https://man.openbsd.org/ssh_config#HostKeyAlias"><code>ssh_config</code> manpage</a>, <code>HostKeyAlias</code> should be used for handling multiple servers running on a single host.</p>
</div>
</div>
<div class="sect2">
<h3 id="multicast_dns">Multicast DNS</h3>
<div class="paragraph">
<p>The following configuration accommodates the variability of the IP address associated with a given hostname on networks using <a href="http://www.multicastdns.org/">multicast DNS</a>.</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="rouge highlight"><code>Host *.local
  CheckHostIP no</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multicast DNS uses the ".local" top-level domain exclusively for hosts on a network.
Setting <a href="https://man.openbsd.org/ssh_config#CheckHostIP"><code>CheckHostIP</code></a> to <code>no</code> here allows IP addresses for any ".local" hosts to change.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It might be worth setting this option for all users in the system-wide configuration file <code>/etc/ssh/ssh_config</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="the_ssh_agent">The SSH Agent</h3>
<div class="paragraph">
<p>The last section contains a few defaults for all hosts, which boil down to a few quality-of-life improvements.</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="rouge highlight"><code>Host *
  AddKeysToAgent yes
  IdentitiesOnly yes
  IdentityFile ~/.ssh/id_rsa_catalina-build.pub
  PreferredAuthentications publickey,keyboard-interactive,password,gssapi-with-mic,hostbased

  # Specific to macOS
  UseKeychain yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>The meanings of these options are described one-by-one below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://man.openbsd.org/ssh_config#AddKeysToAgent"><code>AddKeysToAgent</code></a></dt>
<dd>
<p>Automatically registers SSH keys with the <a href="https://man.openbsd.org/ssh-agent">SSH Agent</a> as they are loaded.</p>
</dd>
<dt class="hdlist1"><a href="https://man.openbsd.org/ssh_config#IdentitiesOnly"><code>IdentitiesOnly</code></a></dt>
<dd>
<p>Limits the identities that will be used to authenticate.
Because I use <a href="https://keepassxc.org/">KeePassXC</a> to handle my SSH keys, the SSH Agent may have lots of other keys loaded which can lead to <a href="https://keepassxc.org/docs/#faq-ssh-agent-auth-errors">authentication problems</a>.</p>
</dd>
<dt class="hdlist1"><a href="https://man.openbsd.org/ssh_config#IdentityFile"><code>IdentityFile</code></a></dt>
<dd>
<p>Provides the path to an authentication identity.
The private key file is often provided for this option, but providing the public key works when storing the private key itself directly within KeePassXC.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.</p>
</dd>
<dt class="hdlist1"><a href="https://man.openbsd.org/ssh_config#PreferredAuthentications"><code>PreferredAuthentications</code></a></dt>
<dd>
<p>Sets the order of preference for the various authentication methods.
Here, public key cryptography is preferred first because I use this most often.</p>
</dd>
<dt class="hdlist1"><code>UseKeychain</code></dt>
<dd>
<p>On macOS, this allows storing and accessing keys from the user&#8217;s Keychain so they are automatically available after logging on.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="ssh_agent_forwarding">SSH Agent Forwarding</h4>
<div class="paragraph">
<p>It is possible to forward the SSH Agent to avoid typing passwords so much.
You can forward the SSH Agent by setting <a href="https://man.openbsd.org/ssh_config#ForwardAgent"><code>ForwardAgent</code></a> to <code>yes</code>, shown in the following example.</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/ssh_config</div>
<div class="content">
<pre class="rouge highlight"><code>Host server
  ForwardAgent yes</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be wary when using agent forwarding.
Those with administrative access on the forwarded machine will be able to use the keys from your agent to authenticate as you.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>That was a bit of configuration.
Assuming I didn&#8217;t just cover topics you already knew, you should have a better understanding of SSH and its configuration options.
Hopefully you&#8217;ll be able to capitalize on this knowledge by simplifying your SSH workflow.
If you&#8217;re interested in smoothing out even more wrinkles in your SSH use, you might checkout the <a href="https://mosh.org/">Mosh</a> project.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://superuser.com/a/1399855/1220231">superuser: OpenSSH - Any way to keep strict host key checking but check only the key and ignore server&#8217;s name?</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://keepassxc.org/docs/#faq-ssh-agent-auth-errors">KeePassXC FAQ: SSH Agent - I&#8217;m getting a "Too many authentication failures" error, what shall I do?</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://apple.stackexchange.com/a/250572/361122">AskDifferent: How can I permanently add my SSH private key to Keychain so it is automatically available to ssh?</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://smallstep.com/blog/ssh-agent-explained/">smallstep Blog: SSH Agent Explained</a>
</div>
</div>
  </div><a class="u-url" href="/my-ssh-configuration-index" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Handy admin and dev guides from my myriad of tinkering</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jwillikers" title="jwillikers"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://stackoverflow.com/users/9835303" title="9835303"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
