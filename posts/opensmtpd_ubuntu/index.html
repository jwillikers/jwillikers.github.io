<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?port=1313&mindelay=10&v=2" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>OpenSMTPD Relay on Ubuntu - JWillikers</title><meta name="Description" content="Jordan Williams&#39; developer blog"><meta property="og:title" content="OpenSMTPD Relay on Ubuntu" />
<meta property="og:description" content="It can be handy to have your system email you if it detects an issue or potential security risk. Unfortunately, this isn&#8217;t always straightforward, especially when you want to send an email from your desktop computer. Sending an email directly from your desktop to your email account is likely going to accomplish nothing. The email will likely be blocked since, to your email provider, it is from an unknown source. I ran into this problem recently trying to set up SmartMonTools to send an email when it detected hard drive errors." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/opensmtpd_ubuntu/" />
<meta property="article:published_time" content="2020-05-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-14T16:30:29-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="OpenSMTPD Relay on Ubuntu"/>
<meta name="twitter:description" content="It can be handy to have your system email you if it detects an issue or potential security risk. Unfortunately, this isn&#8217;t always straightforward, especially when you want to send an email from your desktop computer. Sending an email directly from your desktop to your email account is likely going to accomplish nothing. The email will likely be blocked since, to your email provider, it is from an unknown source. I ran into this problem recently trying to set up SmartMonTools to send an email when it detected hard drive errors."/>
<meta name="application-name" content="JWillikers">
<meta name="apple-mobile-web-app-title" content="JWillikers"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/opensmtpd_ubuntu/" /><link rel="prev" href="http://localhost:1313/posts/openbsd_ipv6/" /><link rel="next" href="http://localhost:1313/posts/smartd_ubuntu/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "OpenSMTPD Relay on Ubuntu",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/opensmtpd_ubuntu\/"
        },"genre": "posts","keywords": "2FA, Email, GMail, Linux, OpenSMTPD, OpenSMTPD6, SMTP, Ubuntu, Ubuntu2004","wordcount":  650 ,
        "url": "http:\/\/localhost:1313\/posts\/opensmtpd_ubuntu\/","datePublished": "2020-05-24T00:00:00+00:00","dateModified": "2020-07-14T16:30:29-05:00","publisher": {
            "@type": "Organization",
            "name": "Jordan Williams"},"author": {
                "@type": "Person",
                "name": "Jordan Williams"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="JWillikers">JWillikers</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/contact/"> Contact </a><a class="menu-item" href="/resources/"> Resources </a><a class="menu-item" href="https://github.com/jwillikers/blog" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="JWillikers">JWillikers</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/contact/" title="">Contact</a><a class="menu-item" href="/resources/" title="">Resources</a><a class="menu-item" href="https://github.com/jwillikers/blog" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">OpenSMTPD Relay on Ubuntu</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jordan Williams</a></span>&nbsp;<span class="post-category">included in <a href="/categories/networking/"><i class="far fa-folder fa-fw"></i>Networking</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-05-24">2020-05-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;650 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"></div>
            </div><div class="content" id="content"><p>It can be handy to have your system email you if it detects an issue or potential security risk.
Unfortunately, this isn&#8217;t always straightforward, especially when you want to send an email from your desktop computer.
Sending an email directly from your desktop to your email account is likely going to accomplish nothing.
The email will likely be blocked since, to your email provider, it is from an unknown source.
I ran into this problem recently trying to set up <a href="https://www.smartmontools.org/">SmartMonTools</a> to send an email when it detected hard drive errors.
The <a href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">Simple Mail Transfer Protocal (SMTP)</a> is perfect for getting around this by <strong>relaying</strong> the email through your account from an established email provider.</p>
<p>In my instance, I wanted to relay the alert through my GMail account, which has nice support for SMTP.
Using an Ubuntu desktop computer, I figured this would be a breeze.
It wasn&#8217;t.
It turned out to be much harder than I anticipated because many guides demonstrate SMTP relay using antiquated applications, such as <a href="https://wiki.archlinux.org/index.php/SSMTP">SSMTP</a>.
Being an <a href="https://www.openbsd.org/">OpenBSD</a> fanboy, I with the modern <a href="https://github.com/OpenSMTPD/OpenSMTPD">OpenSMTPD</a> application.</p>
<section class="doc-section level-1"><h2 id="_instructions">Instructions</h2><p>This brief guide will walk you through relaying emails on Ubuntu 20.04 with OpenSMTPD 6.6.4.</p>
<section class="doc-section level-2"><h3 id="_install">Install</h3><p>First, install OpenSMTPD on Ubuntu.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>apt <span class="nb">install </span>opensmtpd</code></pre></div>
<aside class="admonition-block note" role="note"><h6 class="block-title label-only"><span class="title-label">Note: </span></h6><p>This will probably ask you a couple of questions from an ncurses interface, but it should be fairly self explanatory.</p></aside>
<p>Additionally, you will likely want to install the <code>mailutils</code> package to provide the standard system mail commands.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>apt <span class="nb">install </span>mailutils</code></pre></div>
<aside class="admonition-block note" role="note"><h6 class="block-title label-only"><span class="title-label">Note: </span></h6><p>The <code>mailutils</code> package is required for the verification step at the end of this tutorial.</p></aside></section>
<section class="doc-section level-2"><h3 id="_configure">Configure</h3><p>Grab your email account&#8217;s password.
For my use case, I was using a GMail account which required two-factor authentication.
Because of this, I had to use an <em>App Password</em> instead of my regular password.
For any GMail users in a similar situation, instructions on how to generate an <em>App Password</em> can be found <a href="https://support.google.com/accounts/answer/185833?hl=en">here</a>.</p>
<p>The default configuration file only requires a couple of minor tweaks.
The gist of the configuration is to relay all mail originating from the local machine to a GMail account.</p>
<figure class="listing-block"><figcaption>/etc/smtpd.conf</figcaption>
<pre>#	$OpenBSD: smtpd.conf,v 1.10 2018/05/24 11:40:17 gilles Exp $

# This is the smtpd server system-wide configuration file.
# See smtpd.conf(5) for more information.

table secrets file:/etc/mail/secrets <b class="conum">1</b>
table aliases file:/etc/aliases

# To accept external mail, replace with: listen on all
#
listen on localhost

action "local" maildir alias &lt;aliases&gt;
action "relay" relay host smtp+tls://jdoe@smtp.gmail.com:587 auth &lt;secrets&gt; <b class="conum">2</b>

# Uncomment the following to accept external mail for domain "example.org"
#
# match from any for domain "example.org" action "local"
match for local action "local"
match from local for any action "relay"</pre><ol class="callout-list arabic"><li>Use the content of the file <code>/etc/mail/secrets</code>, shown below, for the <code>secrets</code> table.</li><li>The rule to forward all mail to GMail&#8217;s SMTP server using TLS.</li></ol></figure>

<p>Your account credentials must be associated with a label in the <code>/etc/mail/secrets</code> file.</p>
<p>Create the <code>secrets</code> file.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">mkdir</span> /etc/mail
<span class="gp">$</span><span class="w"> </span><span class="nb">touch</span> /etc/mail/secrets</code></pre></div>
<p>Now, make sure the file&#8217;s permissions are tight before putting your plain-text password inside.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">chmod </span>640 /etc/mail/secrets <b class="conum">1</b>
<span class="gp">$</span><span class="w"> </span><span class="nb">chown </span>root:opensmtpd /etc/mail/secrets <b class="conum">2</b></code></pre><ol class="callout-list arabic"><li>Permit read and write access for the file&#8217;s owner and read access for the file&#8217;s group.</li><li>Set the file&#8217;s ownership such that it belongs to the <code>root</code> user and <code>opensmtpd</code> group.</li></ol></div>

<p>The following example illustrates the file format.</p>
<figure class="listing-block"><figcaption>/etc/mail/secrets</figcaption>
<pre>jdoe jdoe@gmail.com:my_app_password <b class="conum">1</b></pre><ol class="callout-list arabic"><li>Use the label <code>jdoe</code> to represent the account <code>jdoe</code> at <code>gmail.com</code> which has the passphrase <code>my_app_password</code>.</li></ol></figure>

<p>Check that the OpenSMTPD configuration file is valid.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>smtpd <span class="nt">-n</span>
<span class="go">configuration OK</span></code></pre></div>
<p>Restart OpenSMTPD to make sure the configuration changes take effect.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>systemctl restart opensmtpd</code></pre></div>
<p>Enable OpenSMTPD on system startup, if desired.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>systemctl <span class="nb">enable </span>opensmtpd</code></pre></div></section>
<section class="doc-section level-2"><h3 id="_verify">Verify</h3><p>To test the configuration, you can send an email from your computer and check if the email appears in the receiving account.</p>
<p>Send a test email using the <code>mail</code> command from the <code>mailutils</code> package.</p>
<div class="listing-block"><pre class="rouge highlight"><code data-lang="bash"">$ echo "Does it work?" | mail -s "OpenSMTPD Test Email" test@example.com</code></pre></div>
<p>If everything works, you should receive an email at the designated address.</p></section></section>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-07-14</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/2fa/">2FA</a>,&nbsp;<a href="/tags/email/">Email</a>,&nbsp;<a href="/tags/gmail/">GMail</a>,&nbsp;<a href="/tags/linux/">Linux</a>,&nbsp;<a href="/tags/opensmtpd/">OpenSMTPD</a>,&nbsp;<a href="/tags/opensmtpd6/">OpenSMTPD6</a>,&nbsp;<a href="/tags/smtp/">SMTP</a>,&nbsp;<a href="/tags/ubuntu/">Ubuntu</a>,&nbsp;<a href="/tags/ubuntu2004/">Ubuntu2004</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/openbsd_ipv6/" class="prev" rel="prev" title="IPv6 on OpenBSD"><i class="fas fa-angle-left fa-fw"></i>IPv6 on OpenBSD</a>
            <a href="/posts/smartd_ubuntu/" class="next" rel="next" title="Automatically Detect &amp; Report Hard Drive Failure">Automatically Detect &amp; Report Hard Drive Failure<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.74.3">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Jordan Williams</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
