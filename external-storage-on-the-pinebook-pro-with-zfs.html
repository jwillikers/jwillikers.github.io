<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>External Storage on the Pinebook Pro With ZFS | JWillikers</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="External Storage on the Pinebook Pro With ZFS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Handy admin and dev guides from my myriad of tinkering" />
<meta property="og:description" content="Handy admin and dev guides from my myriad of tinkering" />
<link rel="canonical" href="https://jwillikers.com/external-storage-on-the-pinebook-pro-with-zfs" />
<meta property="og:url" content="https://jwillikers.com/external-storage-on-the-pinebook-pro-with-zfs" />
<meta property="og:site_name" content="JWillikers" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-03T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="External Storage on the Pinebook Pro With ZFS" />
<script type="application/ld+json">
{"description":"Handy admin and dev guides from my myriad of tinkering","headline":"External Storage on the Pinebook Pro With ZFS","dateModified":"2020-07-03T00:00:00+00:00","url":"https://jwillikers.com/external-storage-on-the-pinebook-pro-with-zfs","datePublished":"2020-07-03T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jwillikers.com/external-storage-on-the-pinebook-pro-with-zfs"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jwillikers.com/feed.xml" title="JWillikers" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/css/asciidoctor.css"></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">JWillikers</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">External Storage on the Pinebook Pro With ZFS</h1>
    <p class="post-meta"><time class="dt-published" datetime="2020-07-03T00:00:00+00:00" itemprop="datePublished">
        Jul 3, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This tutorial is out-of-date and will be updated when I get ZFS working again on the Pinebook Pro.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="https://www.pine64.org/pinebook-pro/">Pinebook Pro</a> comes with a small amount of internal disk space, only 64 GB.
While this is upgradeable to 128 GB, that still isn&#8217;t enough for those with large media collections.
The easiest solution is to use a microSD card.
And now you&#8217;re just dying to use ZFS on that, right?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tutorial">Tutorial</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Following the previous post, <a href="install_zfs_pinebook_pro.html">Install ZFS on the Pinebook Pro</a>, this tutorial describes the steps required to setup a microSD card for your music files with ZFS on the Pinebook Pro.</p>
</div>
<div class="sect2">
<h3 id="create_the_pool">Create the Pool</h3>
<div class="paragraph">
<p>The microSD card will need to be provisioned as its own pool using ZFS.
Adding the disk to a pool places it under the control of ZFS, providing all of the necessary ZFS capabilities.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, determine which device is the microSD card.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>fdisk <span class="nt">-l</span>
Disk /dev/mmcblk2: 58.25 GiB, 62537072640 bytes, 122142720 sectors
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disklabel <span class="nb">type</span>: dos
Disk identifier: 0x33192aaf

Device         Boot  Start       End   Sectors   Size Id Type
/dev/mmcblk2p1       62500    500000    437501 213.6M  c W95 FAT32 <span class="o">(</span>LBA<span class="o">)</span>
/dev/mmcblk2p2      500001 122142719 121642719    58G 83 Linux


Disk /dev/mmcblk1: 238.51 GiB, 256087425024 bytes, 500170752 sectors
Units: sectors of 1 <span class="k">*</span> 512 <span class="o">=</span> 512 bytes
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512 bytes / 512 bytes
I/O size <span class="o">(</span>minimum/optimal<span class="o">)</span>: 512 bytes / 512 bytes
Disklabel <span class="nb">type</span>: dos
Disk identifier: 0x00000000

Device         Boot Start       End   Sectors   Size Id Type
/dev/mmcblk1p1      65536 500170751 500105216 238.5G  7 HPFS/NTFS/exFAT
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, <code>/dev/mmcblk1</code> is the 256GB microSD card.</p>
</div>
</div>
</div>
</li>
<li>
<p>Next, determine the disk id to use when creating the zpool.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lh</span> /dev/disk/by-id/ | <span class="nb">grep</span> <span class="nt">-w</span> mmcblk1
lrwxrwxrwx 1 root root 13 Jun 24 07:33 mmc-AB5CD_0x00000001 -&gt; ../../mmcblk1</code></pre>
</div>
</div>
</li>
<li>
<p>Then, check the block size.</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>blockdev <span class="nt">--getpbsz</span> /dev/mmcblk1
512</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SD card&#8217;s block size is 512 MiB, which means <code>ashift</code> should be set to 12.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></p>
</div>
</div>
</div>
</li>
<li>
<p>Create the pool.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zpool create <span class="se">\</span>
  <span class="nt">-o</span> <span class="nv">ashift</span><span class="o">=</span>12 <span class="se">\</span>
  <span class="nt">-O</span> <span class="nv">compression</span><span class="o">=</span>on <span class="se">\ </span><i class="conum" data-value="1"></i><b>(1)</b>
  ext_pool mmc-AB5CD_0x00000001</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Turn on compression by default.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the system to automatically import the pool on boot.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zpool <span class="nb">set </span><span class="nv">cachefile</span><span class="o">=</span>/etc/zfs/zpool.cache ext_pool</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="create_the_dataset">Create the Dataset</h3>
<div class="paragraph">
<p>With the microSD card now managed by ZFS, it is now possible to create the ZFS dataset for storing your music.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the ZFS dataset for your tunes.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zfs create <span class="se">\</span>
  <span class="nt">-o</span> <span class="nv">recordsize</span><span class="o">=</span>1M <span class="se">\ </span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="nt">-o</span> <span class="nv">mountpoint</span><span class="o">=</span>/home/jordan/Music <span class="se">\</span>
  ext_pool/music</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A nifty trick here is to use a larger <code>recordsize</code> of 1 MiB which more accurately reflects the filesystem operations for large media files.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></td>
</tr>
</table>
</div>
</li>
<li>
<p>Set the appropriate ownership for the mounted <code>~/Music</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo chown</span> <span class="nt">-R</span> jordan:jordan /home/jordan/Music</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="copy">Copy</h3>
<div class="paragraph">
<p>Now, just copy the music files from wherever they happen to be to the dataset.
The simplest way is to copy the files over the network.
Since the pool is on an SD card, you might just want to pop it out and carry it between machines, so I describe that here.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Export the pool from the Pinebook Pro.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zpool <span class="nb">export </span>ext_pool</code></pre>
</div>
</div>
</li>
<li>
<p>Pop-out the microSD card and pop it into the machine with all of the music.</p>
</li>
<li>
<p>Import the pool.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zpool import ext_pool
cannot mount <span class="s1">'/home/jordan/Music'</span>: directory is not empty</code></pre>
</div>
</div>
</li>
<li>
<p>Change where the music dataset is mounted.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>I keep my music in <code>~/Music</code>, so I have to mount the dataset somewhere else.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zfs <span class="nb">set </span><span class="nv">mountpoint</span><span class="o">=</span>/media/jordan/Music ext_pool/music</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Mount the dataset to the updated location.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zfs mount ext_pool/music</code></pre>
</div>
</div>
</li>
<li>
<p>Set the appropriate ownership for the mounted directory.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo chown </span>jordan:jordan /media/jordan/Music</code></pre>
</div>
</div>
</li>
<li>
<p>Copy over the music.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">tar </span>cfC - /home/jordan/Music <span class="nb">.</span> | <span class="nb">tar </span>xpfC - /media/jordan/Music</code></pre>
</div>
</div>
</li>
<li>
<p>Then change the mount location back to <code>~/Music</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zfs <span class="nb">set </span><span class="nv">mountpoint</span><span class="o">=</span>/home/jordan/Music ext_pool/music
cannot mount <span class="s1">'/home/jordan/Music'</span>: directory is not empty
property may be <span class="nb">set </span>but unable to remount filesystem</code></pre>
</div>
</div>
</li>
<li>
<p>Export the pool from the machine.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zpool <span class="nb">export </span>ext_pool</code></pre>
</div>
</div>
</li>
<li>
<p>Now place the SD card back into the Pinebook Pro, and import the pool again.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>zpool import ext_pool</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="verify">Verify</h3>
<div class="paragraph">
<p>If everything is successful, your music should now be available in <code>~/Music</code>.</p>
</div>
<div class="paragraph">
<p>You should also check that the pool and music dataset are automatically mounted at boot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>reboot</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enjoy">Enjoy</h3>
<div class="paragraph">
<p>You can now enjoy your vast music collection from the comfort of your Pinebook Pro.</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://wiki.archlinux.org/index.php/ZFS#Identify_disks">Arch Linux Wiki: Identify Disks</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://wiki.archlinux.org/index.php/ZFS#Advanced_Format_disks">Arch Linux Wiki: ZFS - Advanced Format Disks</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://wiki.archlinux.org/index.php/ZFS#Creating_ZFS_pools">Arch Linux Wiki: ZFS - Creating ZFS Pools</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://wiki.archlinux.org/index.php/ZFS#Automatic_Start">Arch Linux Wiki: ZFS - Automatic Start</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. <a href="https://jrs-s.net/2019/04/03/on-zfs-recordsize/">JRS Systems: About ZFS recordsize</a>
</div>
</div>
  </div><a class="u-url" href="/external-storage-on-the-pinebook-pro-with-zfs" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Handy admin and dev guides from my myriad of tinkering</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jwillikers" title="jwillikers"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://stackoverflow.com/users/9835303" title="9835303"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
